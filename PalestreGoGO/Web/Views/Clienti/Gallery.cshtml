@model GalleryEditViewModel;
@{
    Layout = "_LayoutClienti";
}

@section Header{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/file-uploader/5.16.2/azure.fine-uploader/fine-uploader-new.min.css" integrity="sha256-I65PS+dIV5Bb65cOVYVn3UAbVeTONYAFwkkJPcPXNGI=" crossorigin="anonymous" />

    @*<script src="~/azure.fine-uploader/azure.fine-uploader.core.js"></script>*@

    @*<link href="~/css/ajax-modal.css" rel="stylesheet" />*@

    <style type="text/css">
        .spinner {
            position: fixed;
            top: 0;
            left: 0;
            text-align: center;
            z-index: 1234;
            overflow: auto;
            width: 100%;
            height: 100%;
        }

        .img-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -50px; /* half width of the spinner gif */
            margin-top: -50px; /* half height of the spinner gif */
            text-align: center;
            z-index: 1234;
            overflow: auto;
            width: 100px; /* width of the spinner gif */
            height: 102px; /*hight of the spinner gif +2px to fix IE8 issue */
        }
    </style>
}

<section id="galleryEdit">
    <h2 class="r2d-section-title">Gestione galleria immagine </h2>
    <input id="fileSelect" type="file" accept="image/*" style="display:none" onchange="handleFiles(this.files)" />

    @{Dictionary<string, string> parms;}

    @for (int row = 0; row < 3; row++)
    {
        <div class="row">
            <div class="col l2 hide-on-med-and-down"></div>
            @for (int col = 1; col <= 3; col++)
            {
                int idx = col + (row * 3);
                parms = new Dictionary<string, string> { { "imageOrder", idx.ToString() } };
                <div class="col s4 l3">
                    @{
                        var imgCurrent = Model.Images.SingleOrDefault(i => i.Ordinamento == idx);
                        <div class="gallery_item_container">
                            <div class="thumb_container">
                                <span class="valign_helper">
                                    <img id='@string.Format("galleryImg-{0}",idx)' class="thumb_image" src='@(imgCurrent?.Url ?? "/img/no-image-available.png")' onclick="choseImage(this, @idx, @(imgCurrent?.Id ??-1))" alt="Immagine @(@idx)" />
                                    <span class="r2g-img-subtitle">Immagine @idx</span>
                                </span>
                            </div>
                            @if (imgCurrent != null)
                            {
                                <a class="inline" onclick="deleteImage(@imgCurrent.Id)">Elimina</a>
                            }
                        </div>
                    }
                    <div class="col l1 hide-on-med-and-down"></div>
                </div>
            }
        </div>
    }
    </div>
</section>

<div id="spinner" class="spinner" style="display:none;">
    <img class="img-spinner" src="~/img/ajax-loader.gif" alt="Loading" />
</div>

<!-- Dialog Modale per la conferma della cancellazione -->
<div id="modalConfermaCanc" class="modal">
    <div class="modal-content">
        <h4>Conferma cancellazione immagine</h4>
        <p>Confermando la cancellazione l'immagine sarà eliminata in modo definitivo e non potrà essere recuperata.</p>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Annulla</a>
        <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat" onclick="ConfirmImageDelete()">Conferma</a>
    </div>
</div>
<div class="ajax-modal"></div>

@section Scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/file-uploader/5.16.2/azure.fine-uploader/azure.fine-uploader.core.min.js" integrity="sha256-ac1yakq7ikaLh6tHHGNOc6x9HtO92LQzQPKX8S1iQf4=" crossorigin="anonymous"></script>

    @*<script src="~/js/jquery-ajax-modal.js"></script>*@

    <script>

        //$(document)
        //    .ajaxStart(function () {
        //        $("#spinner").show();
        //    })
        //    .ajaxStop(function () {
        //        $("#spinner").hide();
        //    });


        var uploader;
        var modal;
        var btnFileSelect;
        var currentFileIdx; //Indice dell'immagine attualmente in upload
        var currentImageId;
        document.addEventListener("DOMContentLoaded", function (event) {
           //Init Uploader
            uploader = new qq.azure.FineUploaderBasic({
                autoUpload: true, //Carica il file sul server appena aggiunto all'uploader
                debug: true,
                warnBeforeUnload: true,
                multiple: false,
                cors: {
                    allowXdr: false,
                    expected:true,
                    sendCredentials: false
                },
                request: {
                    endpoint: "@Model.ContainerUrl"
                },
                signature: {
                    endpoint: "/api/fileupload",
                    customHeaders: {
                        "X-PalestreGoGO-AUTHToken": "@Html.Raw(ViewBag.SASToken)"
                    }
                },
                uploadSuccess: {
                    endpoint: "/api/fileupload",
                    customHeaders: {
                        "X-PalestreGoGO-AUTHToken": "@Html.Raw(ViewBag.SASToken)"
                    }
                },
                callbacks: {
                    onError: function (id, name, errorReason, xhrOrXdr) {
                        alert(qq.format("Error on file number {} - {}.  Reason: {}", id, name, errorReason));
                    },
                    onComplete: function (id, name, responseJSON, xhr) {
                        if (responseJSON.success) {
                            location.reload();
                        }
                        $("#spinner").hide();
                    }
                }
            });
            //Init Modal
            modal = M.Modal.init(document.getElementById('modalConfermaCanc'), {
                //onOpenStart: function (a1, a2, a3) { alert(a1); alert(a2); alert(a3);},
                //onCloseStart: function (a1, a2, a3) { alert(a1); alert(a2); alert(a3); },
                //onCloseEnd: function (a1, a2, a3) { alert(a1); alert(a2); alert(a3); }
            });
            btnFileSelect = document.getElementById('fileSelect');
        });

        function choseImage(e, imageOrder, imgId) {
            var selectedFile;
            currentFileIdx = imageOrder;
            currentImageId = imgId;
            if (btnFileSelect) {
                btnFileSelect.click()
            }
            return false;
        }

        function handleFiles(files) {
            if (files) {
                $("#spinner").show();
                uploader.reset();
                uploader.addFiles(files[0], { fileOrder: currentFileIdx, idCliente: @(ViewBag.IdCliente), imageId = currentImageId });
            }
        }

        function deleteImage(imageId) {
            modal.imageId = imageId;
            modal.open(imageId);
        }

        function ConfirmImageDelete() {
            $('body').addClass('modal-loading');
            $.ajax({
                type: "DELETE",
                url: "./gallery/delete/" + modal.imageId,
                success: function (data) {
                    location.reload();
                },
                error: function (request, textStatus, error) {
                    alert("Errore durante la cancellazione dell'immagine. " + error);
                    $('body').removeClass('modal-loading');
                }
            });
        }
    </script>
}